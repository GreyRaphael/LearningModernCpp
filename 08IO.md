# Files & Streams

- [Files \& Streams](#files--streams)
  - [Read/Write Binary file](#readwrite-binary-file)

## Read/Write Binary file

```cpp
#include <fstream>
#include <iostream>
#include <numeric>  // std::iota
#include <vector>

int main() {
    std::vector<unsigned char> v(50);
    std::iota(v.begin(), v.end(), 1);
    // example1: simple write binary file
    {
        std::ofstream ofile("sample.bin", std::ios::binary);
        if (ofile.is_open()) {
            ofile.write(reinterpret_cast<char*>(v.data()), v.size());
            ofile.close();
        }
    }
    // example2: simple read binary file
    {
        std::vector<unsigned char> v2;
        // std::ios::ate,转到文件末尾
        std::ifstream ifile("sample.bin", std::ios::ate | std::ios::binary);
        size_t readbytes = 0;
        if (ifile.is_open()) {
            auto length = static_cast<size_t>(ifile.tellg());
            // 转到文件开头
            ifile.seekg(0, std::ios_base::beg);

            v2.resize(length);

            try {
                ifile.read(reinterpret_cast<char*>(v2.data()), length);
                readbytes = static_cast<size_t>(ifile.gcount());
            } catch (std::ios_base::failure&) {
                // handle the error
            }
            ifile.close();
        }
        std::cout << "Read:" << readbytes << " Bytes\n";  // Read:50 Bytes
        for (auto& e : v2) {
            std::cout << (int)e << ',';
        }
    }
}
```

example: encapsulated with function

```cpp
#include <fstream>
#include <functional>  // std::function
#include <iostream>
#include <numeric>  // std::iota
#include <vector>

bool write_data(char const* const filename, char const* const data, size_t const size) {
    auto success = false;
    std::ofstream ofile(filename, std::ios::binary);

    if (ofile.is_open()) {
        try {
            ofile.write(data, size);
            success = true;
        } catch (std::ios_base::failure&) {
            // handle the error
        }
        ofile.close();
    }

    return success;
}

size_t read_data(char const* const filename, std::function<char*(size_t const)> allocator) {
    size_t readbytes = 0;
    std::ifstream ifile(filename, std::ios::ate | std::ios::binary);
    if (ifile.is_open()) {
        auto length = static_cast<size_t>(ifile.tellg());
        ifile.seekg(0, std::ios_base::beg);

        auto buffer = allocator(length);

        try {
            ifile.read(buffer, length);
            readbytes = static_cast<size_t>(ifile.gcount());
            std::cout << "Read: " << readbytes << " Bytes\n";
        } catch (std::ios_base::failure&) {
            // handle the error
        }

        ifile.close();
    }

    return readbytes;
}

int main() {
    std::vector<unsigned char> v(50);
    // example1: read data to vector
    {
        std::vector<unsigned char> v2;
        std::iota(v.begin(), v.end(), 1);
        {
            bool write_success = write_data("sample.bin", reinterpret_cast<char*>(v.data()), v.size());
            if (!write_success) exit(0);
            size_t read_bytes = read_data("sample.bin", [&v2](size_t const length) {
                v2.resize(length);
                return reinterpret_cast<char*>(v2.data());
            });
            if (read_bytes > 0) {
                for (auto& e : v2) {
                    std::cout << (int)e << ',';
                }
            }
            std::cout << '\n';
        }
    }
    // example2: read data to array
    {
        unsigned char* v2 = nullptr;
        std::iota(v.begin(), v.end(), 1);
        {
            bool write_success = write_data("sample.bin", reinterpret_cast<char*>(v.data()), v.size());
            if (!write_success) exit(0);
            size_t read_bytes = read_data("sample.bin", [&v2](size_t const length) {
                v2 = new unsigned char[length];
                return reinterpret_cast<char*>(v2);
            });
            if (read_bytes > 0) {
                for (unsigned i = 0; i < read_bytes; ++i) {
                    std::cout << (int)v2[i] << ',';
                }
            }
        }
    }
}
```